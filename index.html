<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Finance Tracker</title> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Firebase compat for icon CSS only; main SDKs imported in module block below -->

<style>
    :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --danger: #f72585;
        --warning: #f8961e;
        --info: #4895ef;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --light-gray: #e9ecef;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fb; color: var(--dark); line-height: 1.6; }

    /* Login Screen Styles */
    #login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(120deg, var(--primary), var(--secondary)); }
    .login-card { background: white; border-radius: 10px; width: 100%; max-width: 400px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); transform: translateY(0); transition: transform 0.3s ease; }
    .login-card:hover { transform: translateY(-5px); }
    .login-header { text-align: center; margin-bottom: 25px; }
    .login-title { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
    .login-subtitle { color: var(--gray); font-size: 16px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
    .input-with-icon { position: relative; }
    .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray); }
    .form-input { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--light-gray); border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
    .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
    .password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray); cursor: pointer; }
    .login-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .remember-me { display: flex; align-items: center; gap: 8px; }
    .forgot-password { color: var(--primary); text-decoration: none; font-size: 14px; }
    .forgot-password:hover { text-decoration: underline; }
    .btn-login { width: 100%; padding: 12px; background-color: var(--primary); color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
    .btn-login:hover { background-color: var(--secondary); }
    .btn-login:disabled { background-color: var(--gray); cursor: not-allowed; }
    .signup-section { text-align: center; margin-top: 20px; color: var(--gray); }
    .signup-link { color: var(--primary); text-decoration: none; font-weight: 500; }
    .signup-link:hover { text-decoration: underline; }
    .error-message { color: var(--danger); font-size: 14px; margin-top: 5px; display: none; }
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Dashboard Styles */
    .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
    header { background: linear-gradient(120deg, var(--primary), var(--secondary)); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .app-title { font-size: 24px; font-weight: 700; }
    .currency-selector { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .dashboard { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }
    .card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .card-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .summary-card { background: white; border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); min-height: 140px; display: flex; flex-direction: column; justify-content: space-between; }
    .summary-card i { font-size: 20px; margin-bottom: 8px; }
    .amount { font-size: 20px; font-weight: 700; margin: 5px 0; }
    .positive { color: #2ecc71; }
    .negative { color: #e74c3c; }
    .neutral { color: var(--gray); }
    .transactions { margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--light-gray); }
    th { background-color: var(--light); font-weight: 600; }
    tr:hover { background-color: #f8f9fa; }
    .btn { display: inline-block; padding: 6px 12px; background-color: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.3s; font-size: 14px; }
    .btn:hover { background-color: var(--secondary); }
    .btn-danger { background-color: var(--danger); }
    .btn-danger:hover { background-color: #c1121f; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-warning { background-color: var(--warning); }
    .payment-method { display: flex; align-items: center; gap: 5px; padding: 4px 8px; background: var(--light-gray); border-radius: 4px; font-size: 12px; }
    .people-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 15px; }
    .person-card { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .person-name { font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .person-balance { font-size: 16px; font-weight: 700; margin: 8px 0; }
    .person-interest { font-size: 12px; color: var(--gray); }
    .action-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .empty-state { text-align: center; padding: 30px 0; color: var(--gray); }
    .empty-state i { font-size: 36px; margin-bottom: 10px; }
    .interest-card { background: linear-gradient(120deg, #ff7e5f, #feb47b); color: white; border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .interest-rate-input { display: flex; align-items: center; gap: 8px; margin-top: 12px; justify-content: center; font-size: 14px; }
    .interest-rate-input input { max-width: 80px; }
    .settings-section { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 15px; }
    .settings-btn { display: flex; align-items: center; gap: 5px; padding: 6px 12px; background: var(--light); border: 1px solid var(--light-gray); border-radius: 5px; cursor: pointer; font-size: 14px; }
    .transaction-details { margin-top: 8px; padding: 8px; background-color: var(--light); border-radius: 5px; font-size: 12px; }
    .transaction-details div { margin-bottom: 4px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { padding: 8px 15px; background: var(--light); border-radius: 5px; cursor: pointer; font-weight: 500; }
    .tab.active { background: var(--primary); color: white; }

    @media (max-width: 768px) {
        .header-content { flex-direction: column; align-items: flex-start; }
        .dashboard { grid-template-columns: 1fr; }
        .summary-cards { grid-template-columns: 1fr; }
        .people-list { grid-template-columns: 1fr; }
        th, td { padding: 8px 10px; }
        .action-buttons { flex-wrap: wrap; }
        .settings-section { flex-direction: column; }
        .login-actions { flex-direction: column; align-items: flex-start; gap: 10px; }
        .forgot-password { margin-top: 5px; }
    }
</style>
</head> <body> <div id="login-container"> <div class="login-card"> <div class="login-header"> <h1 class="login-title"><i class="fas fa-money-bill-transfer"></i> Finance Tracker</h1> <p class="login-subtitle">Sign in to manage your finances</p> </div>
        <form id="login-form">
            <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <div class="input-with-icon">
                    <i class="fas fa-envelope input-icon"></i>
                    <input type="email" id="email" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="error-message" id="email-error">Please enter a valid email address</div>
            </div>

            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <div class="input-with-icon">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                    <button type="button" class="password-toggle" id="password-toggle">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="error-message" id="password-error">Password is required</div>
            </div>

            <div class="login-actions">
                <div class="remember-me">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">Remember me</label>
                </div>
                <a href="#" class="forgot-password" id="forgot-link">Forgot password?</a>
            </div>

            <button type="submit" class="btn-login" id="login-btn">
                <span class="loading-spinner" id="login-spinner"></span>
                Sign In
            </button>

            <div class="error-message" id="login-error" style="text-align: center; margin-top: 15px;"></div>
        </form>

        <div class="signup-section">
            Don't have an account? <a href="#" class="signup-link" id="signup-link">Sign up</a>
        </div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="container">
        <header>
            <div class="header-content">
                <h1 class="app-title"><i class="fas fa-money-bill-transfer"></i> Finance Tracker</h1>
                <div class="currency-selector">
                    <label for="currency">Currency:</label>
                    <select id="currency">
                        <option value="INR" data-symbol="₹">Indian Rupee (₹)</option>
                        <option value="USD" data-symbol="$">US Dollar ($)</option>
                        <option value="EUR" data-symbol="€">Euro (€)</option>
                        <option value="GBP" data-symbol="£">British Pound (£)</option>
                        <option value="JPY" data-symbol="¥">Japanese Yen (¥)</option>
                        <option value="custom">Add Custom...</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn" id="addTransactionBtn"><i class="fas fa-plus"></i> Add Transaction</button>
                    <button class="btn" id="addPersonBtn"><i class="fas fa-user-plus"></i> Add Person</button>
                    <button class="btn btn-warning" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </header>

        <div class="settings-section">
            <div class="settings-btn" id="managePaymentMethods"><i class="fas fa-credit-card"></i> Payment Methods</div>
            <div class="settings-btn" id="manageCategories"><i class="fas fa-tags"></i> Categories</div>
            <div class="settings-btn" id="manageCurrencies"><i class="fas fa-money-bill-wave"></i> Currencies</div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="people">People</div>
            <div class="tab" data-tab="transactions">Transactions</div>
        </div>

        <div class="tab-content" id="overview-tab">
            <div class="summary-cards">
                <div class="summary-card">
                    <i class="fas fa-hand-holding-usd negative"></i>
                    <div>You Owe</div>
                    <div class="amount negative" id="youOwe">₹0</div>
                    <div id="youOweCount">To 0 people</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-money-bill-wave positive"></i>
                    <div>You Are Owed</div>
                    <div class="amount positive" id="youAreOwed">₹0</div>
                    <div id="youAreOwedCount">By 0 people</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-scale-balanced neutral"></i>
                    <div>Net Balance</div>
                    <div class="amount neutral" id="netBalance">₹0</div>
                    <div id="netBalanceText">No transactions yet</div>
                </div>
                <div class="interest-card">
                    <i class="fas fa-percentage"></i>
                    <div>Interest Impact</div>
                    <div class="amount" id="interestImpact">₹0</div>
                    <div id="interestImpactText">Per year at 0%</div>
                    <div class="interest-rate-input">
                        <label for="interestRate">Interest Rate:</label>
                        <input type="number" id="interestRate" value="8" min="0" max="100" step="0.1">
                        <span>% per year</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-users"></i> People Overview</h2>
                <div class="people-list" id="peopleList">
                    <div class="empty-state" id="emptyPeopleState">
                        <i class="fas fa-user-friends"></i>
                        <h3>No people added yet</h3>
                        <p>Add people to start tracking transactions</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="people-tab" style="display: none;">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-users"></i> All People</h2>
                <div class="people-list" id="allPeopleList">
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <h3>No people added yet</h3>
                        <p>Add people to start tracking transactions</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="transactions-tab" style="display: none;">
            <div class="card transactions">
                <h2 class="card-title"><i class="fas fa-list"></i> All Transactions</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Person</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        <tr id="emptyTransactionState">
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-receipt"></i>
                                    <h3>No transactions yet</h3>
                                    <p>Add your first transaction to get started</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Transaction</h2>
                <span class="close">&times;</span>
            </div>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="person">Person</label>
                    <select id="person" required>
                        <option value="">Select a person</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" id="description" placeholder="Enter description" required>
                </div>
                <div class="form-group">
                    <label for="amount">Amount</label>
                    <input type="number" id="amount" placeholder="Enter amount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="type">Transaction Type</label>
                    <select id="type" required>
                        <option value="">Select type</option>
                        <option value="you_paid">You paid</option>
                        <option value="they_paid">They paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Payment Method</label>
                    <select id="paymentMethod" required>
                        <option value="">Select method</option>
                    </select>
                    <button type="button" class="btn btn-sm" id="addPaymentMethodBtn" style="margin-top: 5px;">
                        <i class="fas fa-plus"></i> Add New
                    </button>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="">Select category</option>
                    </select>
                    <button type="button" class="btn btn-sm" id="addCategoryBtn" style="margin-top: 5px;">
                        <i class="fas fa-plus"></i> Add New
                    </button>
                </div>
                <div class="form-group">
                    <label for="utr">UTR (Unique Transaction Reference)</label>
                    <input type="text" id="utr" placeholder="Optional UTR number">
                </div>
                <button type="submit" class="btn">Add Transaction</button>
            </form>
        </div>
    </div>

    <!-- Add Person Modal -->
    <div class="modal" id="personModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Person</h2>
                <span class="close">&times;</span>
            </div>
            <form id="personForm">
                <div class="form-group">
                    <label for="personName">Name</label>
                    <input type="text" id="personName" placeholder="Enter name" required>
                </div>
                <div class="form-group">
                    <label for="relationship">Relationship</label>
                    <select id="relationship" required>
                        <option value="">Select relationship</option>
                        <option value="friend">Friend</option>
                        <option value="family">Family</option>
                        <option value="colleague">Colleague</option>
                        <option value="business">Business</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contact">Contact (Optional)</label>
                    <input type="text" id="contact" placeholder="Phone or email">
                </div>
                <button type="submit" class="btn">Add Person</button>
            </form>
        </div>
    </div>

    <!-- Add Payment Method Modal -->
    <div class="modal" id="paymentMethodModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Payment Method</h2>
                <span class="close">&times;</span>
            </div>
            <form id="paymentMethodForm">
                <div class="form-group">
                    <label for="newPaymentMethod">Payment Method Name</label>
                    <input type="text" id="newPaymentMethod" placeholder="e.g., PhonePe, Google Pay" required>
                </div>
                <button type="submit" class="btn">Add Payment Method</button>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Category</h2>
                <span class="close">&times;</span>
            </div>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="newCategory">Category Name</label>
                    <input type="text" id="newCategory" placeholder="e.g., Travel, Utilities" required>
                </div>
                <button type="submit" class="btn">Add Category</button>
            </form>
        </div>
    </div>

    <!-- Add Currency Modal -->
    <div class="modal" id="currencyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Custom Currency</h2>
                <span class="close">&times;</span>
            </div>
            <form id="currencyForm">
                <div class="form-group">
                    <label for="currencyName">Currency Name</label>
                    <input type="text" id="currencyName" placeholder="e.g., Australian Dollar" required>
                </div>
                <div class="form-group">
                    <label for="currencyCode">Currency Code</label>
                    <input type="text" id="currencyCode" placeholder="e.g., AUD" required>
                </div>
                <div class="form-group">
                    <label for="currencySymbol">Currency Symbol</label>
                    <input type="text" id="currencySymbol" placeholder="e.g., A$" required>
                </div>
                <button type="submit" class="btn">Add Currency</button>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal" id="editTransactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Transaction</h2>
                <span class="close">&times;</span>
            </div>
            <form id="editTransactionForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" required>
                </div>
                <div class="form-group">
                    <label for="editPerson">Person</label>
                    <select id="editPerson" required>
                        <option value="">Select a person</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <input type="text" id="editDescription" placeholder="Enter description" required>
                </div>
                <div class="form-group">
                    <label for="editAmount">Amount</label>
                    <input type="number" id="editAmount" placeholder="Enter amount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editType">Transaction Type</label>
                    <select id="editType" required>
                        <option value="">Select type</option>
                        <option value="you_paid">You paid</option>
                        <option value="they_paid">They paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPaymentMethod">Payment Method</label>
                    <select id="editPaymentMethod" required>
                        <option value="">Select method</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCategory">Category</label>
                    <select id="editCategory" required>
                        <option value="">Select category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUtr">UTR (Unique Transaction Reference)</label>
                    <input type="text" id="editUtr" placeholder="Optional UTR number">
                </div>
                <div class="form-group">
                    <label for="editSettlementDate">Settlement Date (if settled)</label>
                    <input type="date" id="editSettlementDate">
                </div>
                <button type="submit" class="btn">Update Transaction</button>
            </form>
        </div>
    </div>

    <!-- View Person Modal -->
    <div class="modal" id="viewPersonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Person Details</h2>
                <span class="close">&times;</span>
            </div>
            <div id="personDetails"></div>
        </div>
    </div>
</div>

<!-- Firebase SDKs in module scope: expose to window for classic scripts below -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import * as firebaseFs from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import * as firebaseAuth from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Your Firebase config (replace if needed)
    const firebaseConfig = {
        apiKey: "AIzaSyAbbGBFECeYPzZOQDCf9ATxdW1WZpTVX2w",
        authDomain: "transaction-tracker-e9928.firebaseapp.com",
        projectId: "transaction-tracker-e9928",
        storageBucket: "transaction-tracker-e9928.firebasestorage.app",
        messagingSenderId: "869725167353",
        appId: "1:869725167353:dbcd2e6b8fb1e34c28"
    };

    const app = initializeApp(firebaseConfig);
    const db = firebaseFs.getFirestore(app);
    const auth = firebaseAuth.getAuth(app);

    // Expose to window for use in the non-module script
    window.firebaseFs = firebaseFs;
    window.firebaseAuth = firebaseAuth;
    window.db = db;
    window.auth = auth;

    // Example Firestore rules you should set (in Console):
    // match /databases/{database}/documents {
    //   match /users/{userId}/{document=**} {
    //     allow read, write: if request.auth != null && request.auth.uid == userId;
    //   }
    // }
</script>

<!-- App logic: wired to Firestore -->
<script>
    // In-memory state (kept for UI, now driven by Firestore snapshots)
    let transactions = []; // items mapped as {docId, ...data}
    let people = [];       // items mapped as {docId, ...data}
    let paymentMethods = ['Cash', 'Card', 'PhonePe', 'Google Pay', 'Paytm', 'Bank Transfer'];
    let categories = ['Food & Dining', 'Entertainment', 'Transportation', 'Shopping', 'Gifts', 'Utilities'];
    let currencies = [
        { code: 'INR', name: 'Indian Rupee', symbol: '₹' },
        { code: 'USD', name: 'US Dollar', symbol: '$' },
        { code: 'EUR', name: 'Euro', symbol: '€' },
        { code: 'GBP', name: 'British Pound', symbol: '£' },
        { code: 'JPY', name: 'Japanese Yen', symbol: '¥' }
    ];
    let currentCurrency = 'INR';
    let nextTransactionId = 1;
    let nextPersonId = 1;

    // Control adding local sample data only if Firestore is empty after sign-in (first run)
    let addVisualSampleIfEmpty = true;

    // Payment method icons mapping
    const paymentIcons = {
        'cash': 'fa-money-bill-wave',
        'card': 'fa-credit-card',
        'phonepe': 'fa-mobile-alt',
        'google pay': 'fa-google',
        'paytm': 'fa-mobile-alt',
        'bank transfer': 'fa-building',
        'other': 'fa-money-bill-alt'
    };

    // DOM elements for login
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('password-toggle');
    const loginBtn = document.getElementById('login-btn');
    const loginSpinner = document.getElementById('login-spinner');
    const loginError = document.getElementById('login-error');
    const signupLink = document.getElementById('signup-link');
    const logoutBtn = document.getElementById('logoutBtn');
    const forgotLink = document.getElementById('forgot-link');

    // Firestore listeners
    let unsubPeople = null;
    let unsubTransactions = null;

    document.addEventListener('DOMContentLoaded', function() {
        setupLogin();
        setupDashboard();
        setupAuthObserver();
    });

    function setupAuthObserver() {
        const { onAuthStateChanged } = window.firebaseAuth;
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                await startFirestoreSync(user.uid);
            } else {
                stopFirestoreSync();
                transactions = [];
                people = [];
                updateUI();
                document.getElementById('login-container').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });
    }

    function setupLogin() {
        // Toggle password visibility
        passwordToggle.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            const eyeIcon = this.querySelector('i');
            eyeIcon.classList.toggle('fa-eye');
            eyeIcon.classList.toggle('fa-eye-slash');
        });

        // Form validation + login
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            let isValid = true;
            if (!validateEmail(emailInput.value)) {
                document.getElementById('email-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('email-error').style.display = 'none';
            }
            if (!passwordInput.value) {
                document.getElementById('password-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('password-error').style.display = 'none';
            }
            if (isValid) await login();
        });

        // Sign up
        signupLink.addEventListener('click', async function(e) {
            e.preventDefault();
            await signup();
        });

        // Logout
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                window.firebaseAuth.signOut(window.auth);
                emailInput.value = '';
                passwordInput.value = '';
                loginError.style.display = 'none';
            });
        }

        // Forgot password
        if (forgotLink) {
            forgotLink.addEventListener('click', async function(e) {
                e.preventDefault();
                const email = emailInput.value.trim();
                if (!validateEmail(email)) {
                    alert('Enter a valid email first.');
                    return;
                }
                try {
                    await window.firebaseAuth.sendPasswordResetEmail(window.auth, email);
                    alert('Password reset email sent.');
                } catch (err) {
                    alert(err.message || 'Failed to send reset email.');
                }
            });
        }
    }

    async function login() {
        try {
            loginBtn.disabled = true;
            loginSpinner.style.display = 'inline-block';
            loginError.style.display = 'none';
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
        } catch (error) {
            loginError.textContent = error.message || 'Invalid email or password. Please try again.';
            loginError.style.display = 'block';
        } finally {
            loginBtn.disabled = false;
            loginSpinner.style.display = 'none';
        }
    }

    async function signup() {
        try {
            loginBtn.disabled = true;
            loginSpinner.style.display = 'inline-block';
            loginError.style.display = 'none';
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            await window.firebaseAuth.createUserWithEmailAndPassword(window.auth, email, password);
        } catch (error) {
            loginError.textContent = error.message || 'Error creating account. Please try again.';
            loginError.style.display = 'block';
        } finally {
            loginBtn.disabled = false;
            loginSpinner.style.display = 'none';
        }
    }

    function setupDashboard() {
        updateUI();

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                const tabName = this.getAttribute('data-tab');
                document.getElementById(`${tabName}-tab`).style.display = 'block';
            });
        });

        // Modals
        const transactionModal = document.getElementById('transactionModal');
        const personModal = document.getElementById('personModal');
        const paymentMethodModal = document.getElementById('paymentMethodModal');
        const categoryModal = document.getElementById('categoryModal');
        const currencyModal = document.getElementById('currencyModal');
        const editTransactionModal = document.getElementById('editTransactionModal');
        const viewPersonModal = document.getElementById('viewPersonModal');

        const addTransactionBtn = document.getElementById('addTransactionBtn');
        const addPersonBtn = document.getElementById('addPersonBtn');
        const addPaymentMethodBtn = document.getElementById('addPaymentMethodBtn');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const managePaymentMethods = document.getElementById('managePaymentMethods');
        const manageCategories = document.getElementById('manageCategories');
        const manageCurrencies = document.getElementById('manageCurrencies');

        const closeButtons = document.querySelectorAll('.close');

        addTransactionBtn.addEventListener('click', function() {
            transactionModal.style.display = 'flex';
            document.getElementById('date').valueAsDate = new Date();
        });

        addPersonBtn.addEventListener('click', function() {
            personModal.style.display = 'flex';
        });

        addPaymentMethodBtn.addEventListener('click', function() {
            paymentMethodModal.style.display = 'flex';
        });

        addCategoryBtn.addEventListener('click', function() {
            categoryModal.style.display = 'flex';
        });

        managePaymentMethods.addEventListener('click', function() {
            paymentMethodModal.style.display = 'flex';
        });

        manageCategories.addEventListener('click', function() {
            categoryModal.style.display = 'flex';
        });

        manageCurrencies.addEventListener('click', function() {
            currencyModal.style.display = 'flex';
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                transactionModal.style.display = 'none';
                personModal.style.display = 'none';
                paymentMethodModal.style.display = 'none';
                categoryModal.style.display = 'none';
                currencyModal.style.display = 'none';
                editTransactionModal.style.display = 'none';
                viewPersonModal.style.display = 'none';
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target === transactionModal) transactionModal.style.display = 'none';
            if (event.target === personModal) personModal.style.display = 'none';
            if (event.target === paymentMethodModal) paymentMethodModal.style.display = 'none';
            if (event.target === categoryModal) categoryModal.style.display = 'none';
            if (event.target === currencyModal) currencyModal.style.display = 'none';
            if (event.target === editTransactionModal) editTransactionModal.style.display = 'none';
            if (event.target === viewPersonModal) viewPersonModal.style.display = 'none';
        });

        // Forms
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addTransaction();
        });

        document.getElementById('personForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addPerson();
        });

        document.getElementById('paymentMethodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewPaymentMethod();
        });

        document.getElementById('categoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewCategory();
        });

        document.getElementById('currencyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewCurrency();
        });

        document.getElementById('editTransactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await updateTransaction();
        });

        // Currency selector
        document.getElementById('currency').addEventListener('change', function() {
            if (this.value === 'custom') {
                currencyModal.style.display = 'flex';
            } else {
                currentCurrency = this.value;
                updateUI();
            }
        });

        // Interest
        document.getElementById('interestRate').addEventListener('change', function() {
            updateInterestCalculation();
        });
    }

    // Firestore sync
    async function startFirestoreSync(uid) {
        const { collection, query, orderBy, onSnapshot, getDocs } = window.firebaseFs;

        // People
        const peopleRef = collection(window.db, 'users', uid, 'people');
        const peopleQ = query(peopleRef, orderBy('createdAt', 'asc'));
        unsubPeople = onSnapshot(peopleQ, (snap) => {
            people = snap.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
            const maxPersonId = people.reduce((m, p) => Math.max(m, p.id || 0), 0);
            nextPersonId = Math.max(nextPersonId, maxPersonId + 1);
            updateUI();
        });

        // Transactions
        const txRef = collection(window.db, 'users', uid, 'transactions');
        const txQ = query(txRef, orderBy('date', 'desc'));
        unsubTransactions = onSnapshot(txQ, (snap) => {
            transactions = snap.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
            const maxTxId = transactions.reduce((m, t) => Math.max(m, t.id || 0), 0);
            nextTransactionId = Math.max(nextTransactionId, maxTxId + 1);
            updateUI();
        });

        // Optional: add visual sample data only if both collections are empty and flag is on
        if (addVisualSampleIfEmpty) {
            const pSnap = await getDocs(peopleRef);
            const tSnap = await getDocs(txRef);
            if (pSnap.empty && tSnap.empty) {
                await seedSampleData(uid);
            }
            addVisualSampleIfEmpty = false;
        }
    }

    function stopFirestoreSync() {
        if (unsubPeople) { unsubPeople(); unsubPeople = null; }
        if (unsubTransactions) { unsubTransactions(); unsubTransactions = null; }
    }

    async function seedSampleData(uid) {
        const { collection, addDoc, serverTimestamp } = window.firebaseFs;
        const peopleRef = collection(window.db, 'users', uid, 'people');
        const txRef = collection(window.db, 'users', uid, 'transactions');

        const rahul = { id: nextPersonId++, name: 'Rahul', relationship: 'friend', contact: '', createdAt: serverTimestamp() };
        const priya = { id: nextPersonId++, name: 'Priya', relationship: 'family', contact: '', createdAt: serverTimestamp() };
        await addDoc(peopleRef, rahul);
        await addDoc(peopleRef, priya);

        const today = new Date().toISOString().split('T');
        const twoDaysAgo = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T');

        await addDoc(txRef, {
            id: nextTransactionId++,
            date: today,
            person: 'Rahul',
            description: 'Cash',
            amount: 1100000,
            type: 'they_paid',
            paymentMethod: 'Card',
            category: 'Food & Dining',
            utr: 'UTR123456789',
            settlementDate: null,
            createdAt: serverTimestamp()
        });
        await addDoc(txRef, {
            id: nextTransactionId++,
            date: twoDaysAgo,
            person: 'Rahul',
            description: 'Movie tickets',
            amount: 100000,
            type: 'you_paid',
            paymentMethod: 'PhonePe',
            category: 'Entertainment',
            utr: '',
            settlementDate: null,
            createdAt: serverTimestamp()
        });
    }

    // CRUD: People
    async function addPerson() {
        const name = document.getElementById('personName').value.trim();
        const relationship = document.getElementById('relationship').value;
        const contact = document.getElementById('contact').value.trim();
        if (!name || !relationship) return;

        const uid = window.auth.currentUser?.uid;
        if (!uid) return;

        const { collection, addDoc, serverTimestamp } = window.firebaseFs;
        const peopleRef = collection(window.db, 'users', uid, 'people');

        await addDoc(peopleRef, {
            id: nextPersonId++,
            name, relationship, contact,
            createdAt: serverTimestamp()
        });

        document.getElementById('personModal').style.display = 'none';
        document.getElementById('personForm').reset();
    }

    async function deletePerson(id) {
        if (!confirm('Are you sure you want to delete this person and all their transactions?')) return;
        const p = people.find(p => p.id === id);
        if (!p || !p.docId) return;
        const uid = window.auth.currentUser?.uid;
        if (!uid) return;

        const { doc, deleteDoc, collection, getDocs, query, where } = window.firebaseFs;
        // delete their transactions
        const txRef = collection(window.db, 'users', uid, 'transactions');
        const q = query(txRef, where('person', '==', p.name));
        const snap = await getDocs(q);
        const promises = [];
        snap.forEach(d => promises.push(deleteDoc(d.ref)));
        await Promise.all(promises);
        // delete person
        await deleteDoc(doc(window.db, 'users', uid, 'people', p.docId));
    }

    function viewPerson(personId) {
        const person = people.find(p => p.id === personId);
        if (!person) return;

        const personTransactions = transactions.filter(t => t.person === person.name);
        let balance = 0;
        personTransactions.forEach(transaction => {
            if (transaction.type === 'you_paid') balance += transaction.amount;
            else balance -= transaction.amount;
        });

        const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
        const interest = calculateInterestForPerson(person.name, interestRate);

        const personDetails = document.getElementById('personDetails');
        personDetails.innerHTML = `
            <div class="person-card">
                <div class="person-name">${person.name} <span style="font-size: 12px; color: var(--gray);">(${person.relationship})</span></div>
                <div class="person-balance ${balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'neutral'}">
                    ${balance === 0 ? 'Settled up' : balance > 0 ? `Owes you ${formatCurrency(balance)}` : `You owe ${formatCurrency(Math.abs(balance))}`}
                </div>
                <div class="person-interest">Interest Impact: ${formatCurrency(interest)} at ${interestRate}%</div>
                <div class="action-buttons">
                    <button class="btn btn-sm" onclick="settleUpWithPerson(${person.id})">Settle All</button>
                </div>
            </div>
            <h3 style="margin-top: 20px;">Transactions</h3>
            ${
                personTransactions.length === 0
                ? '<p>No transactions with this person</p>'
                : '<table><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Status</th></tr></thead><tbody>' +
                  personTransactions.map(t => `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${t.description}</td>
                        <td class="${t.type === 'you_paid' ? 'positive' : 'negative'}">${formatCurrency(t.amount)}</td>
                        <td>${t.type === 'you_paid' ? 'You paid' : 'They paid'}</td>
                        <td>${t.settlementDate ? 'Settled' : 'Pending'}</td>
                    </tr>
                  `).join('') +
                  '</tbody></table>'
            }
        `;
        document.getElementById('viewPersonModal').style.display = 'flex';
    }

    async function settleUpWithPerson(personId) {
        const person = people.find(p => p.id === personId);
        if (!person) return;
        if (!confirm(`Mark all transactions with ${person.name} as settled?`)) return;

        const uid = window.auth.currentUser?.uid;
        if (!uid) return;

        const { collection, query, where, getDocs, updateDoc, serverTimestamp } = window.firebaseFs;
        const txRef = collection(window.db, 'users', uid, 'transactions');
        const q = query(txRef, where('person', '==', person.name));
        const snap = await getDocs(q);
        const today = new Date().toISOString().split('T');

        const writes = [];
        snap.forEach(docSnap => {
            writes.push(updateDoc(docSnap.ref, { settlementDate: today, settledAt: serverTimestamp() }));
        });
        await Promise.all(writes);
        alert(`All transactions with ${person.name} have been marked as settled.`);
    }

    // CRUD: Transactions
    async function addTransaction() {
        const date = document.getElementById('date').value;
        const person = document.getElementById('person').value;
        const description = document.getElementById('description').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const type = document.getElementById('type').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const category = document.getElementById('category').value;
        const utr = document.getElementById('utr').value.trim();

        if (!date || !person || !description || !amount || !type || !paymentMethod || !category) return;

        const uid = window.auth.currentUser?.uid;
        if (!uid) return;

        const { collection, addDoc, serverTimestamp } = window.firebaseFs;
        const txRef = collection(window.db, 'users', uid, 'transactions');

        await addDoc(txRef, {
            id: nextTransactionId++,
            date, person, description,
            amount,
            type,
            paymentMethod,
            category,
            utr,
            settlementDate: null,
            createdAt: serverTimestamp()
        });

        document.getElementById('transactionModal').style.display = 'none';
        document.getElementById('transactionForm').reset();
    }

    function editTransaction(id) {
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) return;

        document.getElementById('editId').value = transaction.id;
        document.getElementById('editDate').value = transaction.date;
        document.getElementById('editDescription').value = transaction.description;
        document.getElementById('editAmount').value = transaction.amount;
        document.getElementById('editUtr').value = transaction.utr || '';
        document.getElementById('editSettlementDate').value = transaction.settlementDate || '';

        updatePersonDropdown('editPerson');
        updatePaymentMethodDropdown('editPaymentMethod');
        updateCategoryDropdown('editCategory');

        document.getElementById('editPerson').value = transaction.person;
        document.getElementById('editPaymentMethod').value = transaction.paymentMethod;
        document.getElementById('editCategory').value = transaction.category;
        document.getElementById('editType').value = transaction.type;

        document.getElementById('editTransactionModal').style.display = 'flex';
    }

    async function updateTransaction() {
        const id = parseInt(document.getElementById('editId').value);
        const date = document.getElementById('editDate').value;
        const person = document.getElementById('editPerson').value;
        const description = document.getElementById('editDescription').value.trim();
        const amount = parseFloat(document.getElementById('editAmount').value);
        const type = document.getElementById('editType').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        const category = document.getElementById('editCategory').value;
        const utr = document.getElementById('editUtr').value.trim();
        const settlementDate = document.getElementById('editSettlementDate').value || null;

        const tx = transactions.find(t => t.id === id);
        if (!tx || !tx.docId) return;

        const uid = window.auth.currentUser?.uid;
        if (!uid) return;

        const { doc, updateDoc } = window.firebaseFs;
        const txDoc = doc(window.db, 'users', uid, 'transactions', tx.docId);

        await updateDoc(txDoc, {
            date, person, description, amount, type,
            paymentMethod, category, utr, settlementDate
        });

        document.getElementById('editTransactionModal').style.display = 'none';
    }

    async function deleteTransaction(id) {
        if (!confirm('Are you sure you want to delete this transaction?')) return;

        const tx = transactions.find(t => t.id === id);
        if (!tx || !tx.docId) return;

        const uid = window.auth.currentUser?.uid;
        if (!uid) return;

        const { doc, deleteDoc } = window.firebaseFs;
        await deleteDoc(doc(window.db, 'users', uid, 'transactions', tx.docId));
    }

    // UI helpers and updates
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function formatCurrency(amount) {
        const symbol = currencies.find(c => c.code === currentCurrency)?.symbol || '₹';
        return symbol + Math.abs(amount).toLocaleString('en-IN');
    }

    function updateUI() {
        updatePeopleList();
        updateAllPeopleList();
        updateTransactionsTable();
        updatePersonDropdown();
        updatePaymentMethodDropdown();
        updateCategoryDropdown();
        updateSummary();
        updateInterestCalculation();
    }

    function updatePeopleList() {
        const peopleList = document.getElementById('peopleList');
        if (people.length === 0) {
            peopleList.innerHTML = '<div class="empty-state" id="emptyPeopleState"><i class="fas fa-user-friends"></i><h3>No people added yet</h3><p>Add people to start tracking transactions</p></div>';
            return;
        }
        peopleList.innerHTML = '';
        const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;

        people.forEach(person => {
            const personCard = document.createElement('div');
            personCard.className = 'person-card';

            let balance = 0;
            transactions.forEach(transaction => {
                if (transaction.person === person.name) {
                    if (transaction.type === 'you_paid') balance += transaction.amount;
                    else balance -= transaction.amount;
                }
            });

            const interest = calculateInterestForPerson(person.name, interestRate);

            personCard.innerHTML = `
                <div class="person-name">
                    <span>${person.name}</span>
                    <span style="font-size: 12px; color: var(--gray);">${person.relationship}</span>
                </div>
                <div class="person-balance ${balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'neutral'}">
                    ${balance === 0 ? 'Settled up' : balance > 0 ? `Owes you ${formatCurrency(balance)}` : `You owe ${formatCurrency(Math.abs(balance))}`}
                </div>
                <div class="person-interest">Interest: ${formatCurrency(interest)}</div>
                <div class="action-buttons">
                    <button class="btn btn-sm" onclick="settleUpWithPerson(${person.id})">Settle</button>
                    <button class="btn btn-sm" onclick="viewPerson(${person.id})">View</button>
                    <button class="btn btn-danger btn-sm" onclick="deletePerson(${person.id})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            peopleList.appendChild(personCard);
        });
    }

    function updateAllPeopleList() {
        const allPeopleList = document.getElementById('allPeopleList');
        if (people.length === 0) {
            allPeopleList.innerHTML = '<div class="empty-state"><i class="fas fa-user-friends"></i><h3>No people added yet</h3><p>Add people to start tracking transactions</p></div>';
            return;
        }
        allPeopleList.innerHTML = '';
        const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;

        people.forEach(person => {
            const personCard = document.createElement('div');
            personCard.className = 'person-card';

            let balance = 0;
            transactions.forEach(transaction => {
                if (transaction.person === person.name) {
                    if (transaction.type === 'you_paid') balance += transaction.amount;
                    else balance -= transaction.amount;
                }
            });

            const interest = calculateInterestForPerson(person.name, interestRate);

            personCard.innerHTML = `
                <div class="person-name">
                    <span>${person.name}</span>
                    <span style="font-size: 12px; color: var(--gray);">${person.relationship}</span>
                </div>
                <div class="person-balance ${balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'neutral'}">
                    ${balance === 0 ? 'Settled up' : balance > 0 ? `Owes you ${formatCurrency(balance)}` : `You owe ${formatCurrency(Math.abs(balance))}`}
                </div>
                <div class="person-interest">Interest: ${formatCurrency(interest)}</div>
                <div class="action-buttons">
                    <button class="btn btn-sm" onclick="settleUpWithPerson(${person.id})">Settle</button>
                    <button class="btn btn-sm" onclick="viewPerson(${person.id})">View</button>
                    <button class="btn btn-danger btn-sm" onclick="deletePerson(${person.id})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            allPeopleList.appendChild(personCard);
        });
    }

    function updateTransactionsTable() {
        const table = document.getElementById('transactionsTable');
        if (transactions.length === 0) {
            table.innerHTML = '<tr id="emptyTransactionState"><td colspan="7"><div class="empty-state"><i class="fas fa-receipt"></i><h3>No transactions yet</h3><p>Add your first transaction to get started</p></div></td></tr>';
            return;
        }
        table.innerHTML = '';

        const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        sorted.forEach(transaction => {
            const row = document.createElement('tr');
            const dateObj = new Date(transaction.date);
            const formattedDate = `${dateObj.getDate()} ${dateObj.toLocaleString('default', { month: 'short' })} ${dateObj.getFullYear()}`;

            const paymentMethodKey = (transaction.paymentMethod || '').toLowerCase();
            const paymentIcon = paymentIcons[paymentMethodKey] || 'fa-money-bill-alt';

            const amountClass = transaction.type === 'you_paid' ? 'positive' : 'negative';
            const amountSign = transaction.type === 'you_paid' ? '' : '-';

            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${transaction.person}</td>
                <td>${transaction.description} ${transaction.utr ? `<br><small style="color: var(--gray);">UTR: ${transaction.utr}</small>` : ''}</td>
                <td class="${amountClass}">${amountSign}${formatCurrency(transaction.amount)}</td>
                <td><div class="payment-method"><i class="fas ${paymentIcon}"></i> ${transaction.paymentMethod}</div></td>
                <td>${transaction.category}</td>
                <td>
                    <button class="btn btn-sm" onclick="editTransaction(${transaction.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${transaction.id})"><i class="fas fa-trash"></i></button>
                </td>
            `;
            table.appendChild(row);
        });
    }

    function updatePersonDropdown(dropdownId = 'person') {
        const personSelect = document.getElementById(dropdownId);
        while (personSelect.options.length > 1) personSelect.remove(1);
        people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.name;
            option.textContent = person.name;
            personSelect.appendChild(option);
        });
    }

    function updatePaymentMethodDropdown(dropdownId = 'paymentMethod') {
        const paymentMethodSelect = document.getElementById(dropdownId);
        while (paymentMethodSelect.options.length > 1) paymentMethodSelect.remove(1);
        paymentMethods.forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            paymentMethodSelect.appendChild(option);
        });
    }

    function updateCategoryDropdown(dropdownId = 'category') {
        const categorySelect = document.getElementById(dropdownId);
        while (categorySelect.options.length > 1) categorySelect.remove(1);
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }

    function updateSummary() {
        let youOwe = 0;
        let youAreOwed = 0;
        let youOweCount = 0;
        let youAreOwedCount = 0;

        const balances = {};
        people.forEach(person => { balances[person.name] = 0; });

        transactions.forEach(transaction => {
            if (!balances.hasOwnProperty(transaction.person)) return;
            if (transaction.type === 'you_paid') balances[transaction.person] += transaction.amount;
            else balances[transaction.person] -= transaction.amount;
        });

        Object.values(balances).forEach(balance => {
            if (balance < 0) { youOwe += Math.abs(balance); youOweCount++; }
            else if (balance > 0) { youAreOwed += balance; youAreOwedCount++; }
        });

        const netBalance = youAreOwed - youOwe;

        document.getElementById('youOwe').textContent = formatCurrency(youOwe);
        document.getElementById('youAreOwed').textContent = formatCurrency(youAreOwed);
        document.getElementById('netBalance').textContent = formatCurrency(Math.abs(netBalance));
        document.getElementById('youOweCount').textContent = `To ${youOweCount} people`;
        document.getElementById('youAreOwedCount').textContent = `By ${youAreOwedCount} people`;

        if (netBalance > 0) {
            document.getElementById('netBalance').className = 'amount positive';
            document.getElementById('netBalanceText').textContent = 'You are owed more';
        } else if (netBalance < 0) {
            document.getElementById('netBalance').className = 'amount negative';
            document.getElementById('netBalanceText').textContent = 'You owe more';
        } else {
            document.getElementById('netBalance').className = 'amount neutral';
            document.getElementById('netBalanceText').textContent = 'All settled up';
        }
    }

    function calculateInterestForPerson(personName, interestRate) {
        let totalInterest = 0;
        transactions.forEach(transaction => {
            if (transaction.person === personName) {
                const transactionDate = new Date(transaction.date);
                const settlementDate = transaction.settlementDate ? new Date(transaction.settlementDate) : new Date();
                const days = Math.max(0, (settlementDate - transactionDate) / (1000 * 60 * 60 * 24));
                const interest = (transaction.amount * interestRate * days) / (100 * 365);
                if (transaction.type === 'they_paid') totalInterest += interest;
                else totalInterest -= interest;
            }
        });
        return totalInterest;
    }

    function updateInterestCalculation() {
        const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
        let totalInterest = 0;
        people.forEach(person => { totalInterest += calculateInterestForPerson(person.name, interestRate); });

        document.getElementById('interestImpact').textContent = formatCurrency(Math.abs(totalInterest));
        if (totalInterest > 0) {
            document.getElementById('interestImpact').className = 'amount positive';
            document.getElementById('interestImpactText').textContent = `Net interest gain at ${interestRate}%`;
        } else if (totalInterest < 0) {
            document.getElementById('interestImpact').className = 'amount negative';
            document.getElementById('interestImpactText').textContent = `Net interest loss at ${interestRate}%`;
        } else {
            document.getElementById('interestImpact').className = 'amount neutral';
            document.getElementById('interestImpactText').textContent = `No interest impact at ${interestRate}%`;
        }
        updatePeopleList();
        updateAllPeopleList();
    }

    // Settings: add new items (local-only persistence for now)
    function addNewPaymentMethod() {
        const newMethod = document.getElementById('newPaymentMethod').value.trim();
        if (newMethod && !paymentMethods.includes(newMethod)) {
            paymentMethods.push(newMethod);
            updatePaymentMethodDropdown();
            document.getElementById('paymentMethodModal').style.display = 'none';
            document.getElementById('paymentMethodForm').reset();
            alert('Payment method added successfully!');
        } else if (paymentMethods.includes(newMethod)) {
            alert('This payment method already exists!');
        }
    }

    function addNewCategory() {
        const newCategory = document.getElementById('newCategory').value.trim();
        if (newCategory && !categories.includes(newCategory)) {
            categories.push(newCategory);
            updateCategoryDropdown();
            document.getElementById('categoryModal').style.display = 'none';
            document.getElementById('categoryForm').reset();
            alert('Category added successfully!');
        } else if (categories.includes(newCategory)) {
            alert('This category already exists!');
        }
    }

    function addNewCurrency() {
        const name = document.getElementById('currencyName').value.trim();
        const code = document.getElementById('currencyCode').value.trim().toUpperCase();
        const symbol = document.getElementById('currencySymbol').value.trim();
        if (name && code && symbol) {
            if (currencies.some(c => c.code === code)) {
                alert('This currency code already exists!');
                return;
            }
            currencies.push({ name, code, symbol });
            const currencySelect = document.getElementById('currency');
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${name} (${symbol})`;
            currencySelect.insertBefore(option, currencySelect.lastElementChild);
            currencySelect.value = code;
            currentCurrency = code;
            document.getElementById('currencyModal').style.display = 'none';
            document.getElementById('currencyForm').reset();
            updateUI();
            alert('Currency added successfully!');
        }
    }
</script>
</body> </html>
